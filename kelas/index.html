<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Keterlambatan Siswa</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Modern & Clean */
        :root {
            --primary-color: #4a90e2;
            --primary-light: #eaf2fb;
            --text-dark: #2c3e50;
            --text-light: #8a97a6;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --border-color: #e1e4e8;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.05);
        }
        h1 {
            text-align: center;
            color: var(--text-dark);
            margin-bottom: 5px;
            font-weight: 700;
        }
        .subtitle {
            text-align: center;
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 40px;
        }
        /* Filter Styles */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 8px;
        }
        .filters label {
            font-weight: 600;
            align-self: center;
            color: var(--text-light);
        }
        .filters select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--card-background);
            font-weight: 600;
            color: var(--text-dark);
        }
        /* Statistik Styles */
        #stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            text-align: center;
        }
        .stat-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: var(--text-light);
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .stat-card p {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        /* Podium Styles */
        #podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 250px;
            padding: 20px 0;
            margin-bottom: 40px;
            gap: 5px;
        }
        .podium-step {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            width: 18%;
            max-width: 120px;
            text-align: center;
            transition: height 0.5s ease-out;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 10px 5px;
            box-shadow: inset 0 -10px 15px rgba(0,0,0,0.03);
        }
        .podium-step[data-rank="1"] { background: linear-gradient(to top, #3a7bd5, #3a60d5); } /* Peringkat 1 */
        .podium-step[data-rank="2"] { background: linear-gradient(to top, #5e94e8, #6ba1ea); } /* Peringkat 2 */
        .podium-step[data-rank="3"] { background: linear-gradient(to top, #7daeed, #94c2ff); } /* Peringkat 3 */
        .podium-step[data-rank="4"], .podium-step[data-rank="5"] { background: linear-gradient(to top, #e1e4e8, #e8eaed); }

        .podium-icon { font-size: 2em; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .podium-name { font-weight: 600; font-size: 0.9em; margin-top: 5px; word-wrap: break-word; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);}
        .podium-step[data-rank="4"] .podium-name, .podium-step[data-rank="5"] .podium-name { color: var(--text-dark); text-shadow: none;}
        .podium-score {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-dark);
            background-color: var(--card-background);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 8px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* Tabel Klasemen */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        thead th {
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            font-size: 0.85em;
            border-bottom-width: 2px;
        }
        tbody tr:hover {
            background-color: var(--primary-light);
        }
        /* Lencana (Badges) */
        .badge {
            display: inline-block;
            width: 20px;
            text-align: center;
            margin-left: 8px;
            font-size: 1em;
        }
        /* Tombol Cetak */
        .print-button {
            display: block;
            width: 150px;
            margin: 40px auto 0;
            padding: 12px;
            text-align: center;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .print-button:hover {
            background-color: #3a7bd5;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }
        /* Aturan untuk mencetak */
        @media print {
            body { padding: 0; background-color: white; }
            .container { box-shadow: none; padding: 0; }
            .filters, .print-button, #podium-container { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üèÜ Rekap Keterlambatan Siswa XII-2</h1>
    <p class="subtitle">Data diperbarui secara otomatis dari Google Sheet.</p>

    <!-- Filter Bulan dan Tahun -->
    <div class="filters">
        <div>
            <label for="filter-tahun">Tahun:</label>
            <select id="filter-tahun">
                <option value="semua">Semua Tahun</option>
            </select>
        </div>
        <div>
            <label for="filter-bulan">Bulan:</label>
            <select id="filter-bulan">
                <option value="semua">Semua Bulan</option>
            </select>
        </div>
    </div>

    <!-- Visualisasi Podium -->
    <div id="podium-container">
        <!-- Podium akan dibuat oleh JavaScript -->
    </div>

    <!-- Analisis Tren & Statistik Menarik -->
    <div id="stats-container">
        <div class="stat-card">
            <h3>Total Keterlambatan</h3>
            <p id="total-late-count">0</p>
        </div>
        <div class="stat-card">
            <h3>Hari Paling Rawan</h3>
            <p id="most-late-day">-</p>
        </div>
    </div>

    <!-- Tabel Klasemen dengan Lencana -->
    <table>
        <thead>
            <tr>
                <th>Peringkat</th>
                <th>Nama Siswa</th>
                <th>Total Terlambat</th>
            </tr>
        </thead>
        <tbody id="data-klasemen">
            <tr><td colspan="3" style="text-align: center;">Memuat data...</td></tr>
        </tbody>
    </table>

    <button class="print-button" onclick="window.print()">Cetak Laporan</button>
</div>

<script>
    // =================================================================================
    // ## PENTING: Ganti URL di bawah ini dengan URL CSV dari Google Sheet Anda ##
    // =================================================================================
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQWPV-ygrhLMjDvEM0sg_4L3d2SuPPZt0fN0TBAt2ycGTpJirqPJTxIGVs_aOreswmtzaXtykriMy1R/pub?output=csv';

    let allLines = [];
    let headers = [];

    document.addEventListener('DOMContentLoaded', () => {
        fetch(sheetURL)
            .then(response => {
                if (!response.ok) throw new Error('Gagal mengambil data dari Google Sheet.');
                return response.text();
            })
            .then(csvText => {
                const lines = csvText.split('\n');
                if (lines.length < 2) {
                    document.getElementById('data-klasemen').innerHTML = '<tr><td colspan="3" style="text-align: center;">Tidak ada data untuk diproses.</td></tr>';
                    return;
                };

                headers = lines[0].split(',').map(h => h.replace(/\[|\]/g, '').trim());
                allLines = lines.slice(1);

                populateFilters();
                updateDisplay();
            })
            .catch(error => {
                console.error("Error:", error);
                document.getElementById('data-klasemen').innerHTML = `<tr><td colspan="3" style="text-align: center;">Terjadi kesalahan: ${error.message}</td></tr>`;
            });

        document.getElementById('filter-tahun').addEventListener('change', updateDisplay);
        document.getElementById('filter-bulan').addEventListener('change', updateDisplay);
    });

    function populateFilters() {
        const yearSelect = document.getElementById('filter-tahun');
        const monthSelect = document.getElementById('filter-bulan');
        const availableYears = new Set();
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        monthNames.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            monthSelect.appendChild(option);
        });

        allLines.forEach(line => {
            const columns = line.split(',');
            const dateString = columns[1];
            if (dateString) {
                const date = new Date(dateString);
                if (!isNaN(date.getFullYear())) availableYears.add(date.getFullYear());
            }
        });

        Array.from(availableYears).sort((a, b) => b - a).forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });
    }

    function updateDisplay() {
        const selectedYear = document.getElementById('filter-tahun').value;
        const selectedMonth = document.getElementById('filter-bulan').value;

        const filteredLines = allLines.filter(line => {
            if (!line) return false;
            const columns = line.split(',');
            const dateString = columns[1];
            if (!dateString) return false;
            const parts = dateString.split('/');
            if(parts.length !== 3) return false;
            const date = new Date(parts[2], parts[0] - 1, parts[1]);
            if (isNaN(date.getTime())) return false;
            const yearMatches = (selectedYear === 'semua') || (date.getFullYear() == selectedYear);
            const monthMatches = (selectedMonth === 'semua') || (date.getMonth() == selectedMonth);
            return yearMatches && monthMatches;
        });
        
        const leaderboardData = processLeaderboard(filteredLines);
        displayLeaderboard(leaderboardData);
        displayStats(filteredLines);
        displayPodium(leaderboardData);
    }

    function processLeaderboard(filteredLines) {
        const records = {};
        for (let i = 2; i < headers.length; i++) {
            const studentName = headers[i];
            if (studentName) records[studentName] = { nama: studentName, total_terlambat: 0 };
        }

        filteredLines.forEach(line => {
            const columns = line.split(',');
            for (let j = 2; j < columns.length; j++) {
                const studentName = headers[j];
                const isLate = columns[j] && columns[j].trim() === '1';
                if (isLate && records[studentName]) records[studentName].total_terlambat++;
            }
        });

        return Object.values(records).sort((a, b) => b.total_terlambat - a.total_terlambat);
    }

    function displayLeaderboard(sortedRecords) {
        const tbody = document.getElementById('data-klasemen');
        tbody.innerHTML = ''; 

        if (sortedRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Tidak ada data untuk filter ini.</td></tr>';
            return;
        }

        const lateValues = [...new Set(sortedRecords.map(s => s.total_terlambat).filter(t => t > 0))];
        const rank1Value = lateValues[0] || -1;
        const rank2Value = lateValues[1] || -1;
        const rank3Value = lateValues[2] || -1;

        sortedRecords.forEach((record, index) => {
            let badge = '';
            if (record.total_terlambat === 0) {
                badge = '<span class="badge">üëë</span>';
            } else if (record.total_terlambat === rank1Value) {
                badge = '<span class="badge">ü•á</span>';
            } else if (record.total_terlambat === rank2Value) {
                badge = '<span class="badge">ü•à</span>';
            } else if (record.total_terlambat === rank3Value) {
                badge = '<span class="badge">ü•â</span>';
            }

            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${record.nama} ${badge}</td>
                    <td>${record.total_terlambat}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function displayStats(filteredLines) {
        let totalLateCount = 0;
        const dayCounts = [0, 0, 0, 0, 0, 0, 0];
        const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

        filteredLines.forEach(line => {
            const columns = line.split(',');
            const dateString = columns[1];
            if(dateString) {
                const parts = dateString.split('/');
                const date = new Date(parts[2], parts[0] - 1, parts[1]);
                if (!isNaN(date.getTime())) dayCounts[date.getDay()]++;
            }
            for (let i = 2; i < columns.length; i++) {
                if (columns[i] && columns[i].trim() === '1') totalLateCount++;
            }
        });

        let maxDayIndex = 1;
        if(totalLateCount > 0) {
             for (let i = 0; i < dayCounts.length; i++) {
                if (dayCounts[i] > dayCounts[maxDayIndex]) maxDayIndex = i;
            }
        }
        
        document.getElementById('total-late-count').textContent = totalLateCount;
        document.getElementById('most-late-day').textContent = totalLateCount > 0 ? dayNames[maxDayIndex] : '-';
    }

    function displayPodium(sortedRecords) {
        const podiumContainer = document.getElementById('podium-container');
        podiumContainer.innerHTML = '';
        const top5Records = sortedRecords.filter(r => r.total_terlambat > 0).slice(0, 5);
        
        if (top5Records.length === 0) {
            podiumContainer.style.height = '50px'; // Perkecil jika kosong
            return;
        }
        podiumContainer.style.height = '250px'; // Kembalikan tinggi normal

        const podiumLayout = [
            { order: 3, height: '100%' }, // Peringkat 1 -> slot visual ke-3 (tengah)
            { order: 2, height: '80%' },  // Peringkat 2 -> slot visual ke-2
            { order: 4, height: '65%' },  // Peringkat 3 -> slot visual ke-4
            { order: 1, height: '50%' },  // Peringkat 4 -> slot visual ke-1
            { order: 5, height: '35%' }   // Peringkat 5 -> slot visual ke-5
        ];

        const medals = ['ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üèÖ'];
        const lateValues = [...new Set(sortedRecords.map(s => s.total_terlambat).filter(t => t > 0))];

        top5Records.forEach((record, index) => {
            const layout = podiumLayout[index];
            const actualRank = lateValues.indexOf(record.total_terlambat);
            const medal = medals[actualRank] !== undefined ? medals[actualRank] : 'üèÖ';

            const step = document.createElement('div');
            step.className = 'podium-step';
            step.style.order = layout.order;
            step.style.height = layout.height;
            step.dataset.rank = actualRank + 1;

            step.innerHTML = `
                <div class="podium-icon">${medal}</div>
                <div class="podium-name">${record.nama}</div>
                <div class="podium-score">${record.total_terlambat}</div>
            `;
            podiumContainer.appendChild(step);
        });
    }

</script>

</body>
</html>

