<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSim - Simulator Jaringan Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F8FAFC;
            overflow: hidden;
        }
        .canvas-area {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 30px 30px;
            position: relative;
            touch-action: none;
        }
        .device {
            transition: transform 0.1s ease;
            cursor: grab;
            user-select: none;
        }
        .device:active { cursor: grabbing; }
        .node-active { filter: drop-shadow(0 0 10px rgba(14, 165, 233, 0.8)); }
        
        /* Animasi Nadi (Pulse) */
        @keyframes pulse-blue {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { transform: scale(1.15); box-shadow: 0 0 0 8px rgba(14, 165, 233, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }
        .ping-btn-animate {
            animation: pulse-blue 1.5s infinite;
        }

        .packet {
            pointer-events: none;
            z-index: 100;
        }
        .log-entry {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Cursor khusus saat mode ping */
        .cursor-ping { cursor: crosshair !important; }
        .target-mode { border: 2px dashed #0ea5e9 !important; border-radius: 12px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center z-50">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-sky-100 rounded-lg">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0ea5e9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>
            </div>
            <h1 class="text-xl font-semibold text-slate-800 tracking-tight">NetSim <span class="text-sky-500 text-sm font-normal">v1.2</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="resetSimulation()" class="px-4 py-2 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">Reset</button>
            <button onclick="toggleConnectionMode()" id="cableBtn" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-lg shadow-sm transition-all flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v5"></path><path d="M10 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v5"></path><path d="M6 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v5"></path><path d="M22 11a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9h20z"></path></svg>
                <span>Hubungkan Kabel</span>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-20 md:w-64 bg-white border-r border-slate-200 p-4 flex flex-col gap-6 z-40">
            <div>
                <h2 class="hidden md:block text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Toolbar Perangkat</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="addDevice('PC')" class="group flex flex-col items-center p-3 rounded-xl hover:bg-sky-50 border border-transparent hover:border-sky-100 transition-all">
                        <div class="w-10 h-10 flex items-center justify-center bg-sky-50 text-sky-600 rounded-lg group-hover:bg-white shadow-sm">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                        </div>
                        <span class="text-[10px] md:text-xs mt-2 text-slate-600 font-medium">PC</span>
                    </button>
                    <button onclick="addDevice('Router')" class="group flex flex-col items-center p-3 rounded-xl hover:bg-yellow-50 border border-transparent hover:border-yellow-100 transition-all">
                        <div class="w-10 h-10 flex items-center justify-center bg-yellow-50 text-yellow-600 rounded-lg group-hover:bg-white shadow-sm">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 8 8 12 12 16"></polyline><polyline points="16 12 12 8"></polyline><line x1="12" y1="8" x2="12" y2="16"></line></svg>
                        </div>
                        <span class="text-[10px] md:text-xs mt-2 text-slate-600 font-medium">Router</span>
                    </button>
                    <button onclick="addDevice('Switch')" class="group flex flex-col items-center p-3 rounded-xl hover:bg-emerald-50 border border-transparent hover:border-emerald-100 transition-all">
                        <div class="w-10 h-10 flex items-center justify-center bg-emerald-50 text-emerald-600 rounded-lg group-hover:bg-white shadow-sm">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="6" y1="9" x2="18" y2="15"></line><line x1="18" y1="9" x2="6" y2="15"></line></svg>
                        </div>
                        <span class="text-[10px] md:text-xs mt-2 text-slate-600 font-medium">Switch</span>
                    </button>
                    <button onclick="addDevice('Hub')" class="group flex flex-col items-center p-3 rounded-xl hover:bg-purple-50 border border-transparent hover:border-purple-100 transition-all">
                        <div class="w-10 h-10 flex items-center justify-center bg-purple-50 text-purple-600 rounded-lg group-hover:bg-white shadow-sm">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"></rect><circle cx="12" cy="12" r="3"></circle></svg>
                        </div>
                        <span class="text-[10px] md:text-xs mt-2 text-slate-600 font-medium">Hub</span>
                    </button>
                </div>
            </div>

            <div class="mt-auto md:block hidden">
                <div id="info-box" class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl text-xs text-yellow-800 leading-relaxed">
                    <h3 class="font-bold mb-1 flex items-center gap-1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        Panduan
                    </h3>
                    <p id="info-text">Tarik perangkat ke kanvas, lalu pasang kabel untuk menghubungkan.</p>
                </div>
            </div>
        </aside>

        <section id="canvas" class="flex-1 canvas-area relative overflow-hidden">
            <svg id="connection-svg" class="absolute inset-0 w-full h-full pointer-events-none"></svg>
        </section>

        <aside class="w-80 bg-white border-l border-slate-200 flex flex-col z-40 md:flex hidden">
            <div class="p-4 border-b border-slate-100">
                <h2 class="text-sm font-semibold text-slate-800">Log Aktivitas</h2>
            </div>
            <div id="ping-log" class="flex-1 overflow-y-auto p-4 space-y-2 text-[11px] font-mono">
                <div class="text-slate-400 italic">Menunggu aktivitas...</div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200">
                <div class="text-[10px] text-slate-500 flex items-center justify-between uppercase font-bold tracking-widest mb-2">
                    <span>Statistik Sesi</span>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <div class="text-xl font-semibold text-slate-700" id="stat-devices">0</div>
                        <div class="text-[9px] text-slate-500 uppercase">Perangkat</div>
                    </div>
                    <div class="flex-1">
                        <div class="text-xl font-semibold text-slate-700" id="stat-pings">0</div>
                        <div class="text-[9px] text-slate-500 uppercase">Uji Ping</div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Modal Konfigurasi -->
    <div id="configModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="p-6 border-b border-slate-100">
                <h3 id="modalTitle" class="text-lg font-semibold text-slate-800">Setting Perangkat</h3>
                <p class="text-xs text-slate-500">Masukkan IP Address untuk komunikasi.</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">IP Address</label>
                    <input type="text" id="inputIP" placeholder="192.168.1.1" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500/20 focus:border-sky-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Subnet Mask</label>
                    <input type="text" id="inputMask" placeholder="255.255.255.0" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-sky-500/20 outline-none">
                </div>
                <div id="conflictAlert" class="p-3 bg-red-50 text-red-600 rounded-lg text-xs hidden">
                    Konflik IP! Perangkat lain sudah menggunakan IP ini.
                </div>
            </div>
            <div class="p-4 bg-slate-50 flex gap-2">
                <button onclick="closeModal()" class="flex-1 py-2 text-sm text-slate-500 hover:bg-slate-200 rounded-lg">Batal</button>
                <button onclick="saveConfig()" class="flex-1 py-2 text-sm text-white bg-sky-500 hover:bg-sky-600 rounded-lg font-medium">Simpan</button>
            </div>
        </div>
    </div>

    <!-- UI Feedback Area -->
    <div id="pingFeedback" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl text-sm hidden z-[200] flex items-center gap-3">
        <span id="pingFeedbackText"></span>
    </div>

    <script>
        // State Global
        let devices = [];
        let connections = [];
        let deviceCounter = 0;
        let selectedDevice = null;
        
        let isConnectingMode = false;
        let connectionSource = null;
        
        let isPingMode = false;
        let pingSource = null;

        let draggingDevice = null;
        let dragOffset = { x: 0, y: 0 };
        let stats = { devices: 0, pings: 0 };

        const canvas = document.getElementById('canvas');
        const svgLayer = document.getElementById('connection-svg');
        const infoText = document.getElementById('info-text');

        // Logic Perangkat
        function addDevice(type) {
            const id = `dev-${++deviceCounter}`;
            const device = {
                id, type, 
                x: 150 + (Math.random() * 50), 
                y: 150 + (Math.random() * 50),
                ip: '', mask: '255.255.255.0'
            };
            devices.push(device);
            renderDevice(device);
            updateStats();
            updateInfo(`Menambahkan ${type}.`);
        }

        function renderDevice(dev) {
            const div = document.createElement('div');
            div.id = dev.id;
            div.className = `device absolute z-10 p-2 flex flex-col items-center group`;
            div.style.left = `${dev.x}px`;
            div.style.top = `${dev.y}px`;

            let icon = '';
            let color = 'text-slate-600';
            if (dev.type === 'PC') {
                icon = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>';
                color = 'text-sky-500';
            } else if (dev.type === 'Router') {
                icon = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 8 8 12 12 16"></polyline><polyline points="16 12 12 8"></polyline><line x1="12" y1="8" x2="12" y2="16"></line></svg>';
                color = 'text-yellow-500';
            } else if (dev.type === 'Switch') {
                icon = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="6" y1="9" x2="18" y2="15"></line><line x1="18" y1="9" x2="6" y2="15"></line></svg>';
                color = 'text-emerald-500';
            } else if (dev.type === 'Hub') {
                icon = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"></rect><circle cx="12" cy="12" r="3"></circle></svg>';
                color = 'text-purple-500';
            }

            div.innerHTML = `
                <div class="device-body relative">
                    <div class="device-icon-box ${color} bg-white p-2 rounded-xl shadow-md group-hover:shadow-lg transition-all border-2 border-transparent">
                        ${icon}
                    </div>
                </div>
                <span class="text-[10px] font-bold mt-1 bg-white px-2 rounded-full border border-slate-100">${dev.type} ${dev.id.split('-')[1]}</span>
                <span class="device-ip-display text-[9px] text-slate-400 mt-0.5">${dev.ip || 'no-ip'}</span>
                <button onclick="removeDevice(event, '${dev.id}')" class="absolute -bottom-6 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            `;

            div.addEventListener('mousedown', (e) => startDrag(e, dev));
            div.addEventListener('click', (e) => handleInteraction(e, dev));
            
            canvas.appendChild(div);
            if (dev.ip) addPingButton(dev);
        }

        // --- Interaction Handler (Fix Utama) ---
        function handleInteraction(e, dev) {
            e.stopPropagation();

            // Mode 1: Menghubungkan Kabel
            if (isConnectingMode) {
                if (!connectionSource) {
                    connectionSource = dev;
                    document.getElementById(dev.id).classList.add('node-active');
                    updateInfo("Pilih perangkat kedua untuk disambungkan.");
                } else if (connectionSource.id !== dev.id) {
                    addConnection(connectionSource, dev);
                    exitModes();
                }
                return;
            }

            // Mode 2: Memilih Target Ping (Solusi Perbaikan)
            if (isPingMode) {
                if (dev.id !== pingSource.id) {
                    executePing(pingSource, dev);
                    exitModes();
                }
                return;
            }

            // Mode 3: Klik Biasa (Buka Config)
            openConfig(dev);
        }

        function exitModes() {
            isConnectingMode = false;
            isPingMode = false;
            connectionSource = null;
            pingSource = null;
            
            document.querySelectorAll('.device').forEach(d => {
                d.classList.remove('node-active', 'target-mode');
            });
            document.body.classList.remove('cursor-ping');
            document.getElementById('cableBtn').classList.replace('bg-red-500', 'bg-sky-500');
            updateInfo("Mode normal aktif.");
        }

        function toggleConnectionMode() {
            if (isConnectingMode) return exitModes();
            exitModes();
            isConnectingMode = true;
            document.getElementById('cableBtn').classList.replace('bg-sky-500', 'bg-red-500');
            updateInfo("Mode Kabel: Klik perangkat asal, lalu perangkat tujuan.");
        }

        function startPingFlow(source) {
            exitModes();
            isPingMode = true;
            pingSource = source;
            document.body.classList.add('cursor-ping');
            updateInfo(`Ping: Pilih perangkat tujuan dari ${source.id}.`);
            
            // Beri indikasi visual pada calon target
            document.querySelectorAll('.device').forEach(el => {
                if (el.id !== source.id) el.classList.add('target-mode');
            });
            document.getElementById(source.id).classList.add('node-active');
        }

        // --- Core Networking ---
        function addConnection(from, to) {
            const exists = connections.some(c => (c.from === from.id && c.to === to.id) || (c.from === to.id && c.to === from.id));
            if (!exists) {
                connections.push({ from: from.id, to: to.id });
                drawConnections();
                logAction(`Koneksi terbentuk antara ${from.type} dan ${to.type}.`, 'info');
            }
        }

        function drawConnections() {
            svgLayer.innerHTML = '';
            connections.forEach(conn => {
                const a = devices.find(d => d.id === conn.from);
                const b = devices.find(d => d.id === conn.to);
                if (a && b) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", a.x + 30); line.setAttribute("y1", a.y + 30);
                    line.setAttribute("x2", b.x + 30); line.setAttribute("y2", b.y + 30);
                    line.setAttribute("stroke", "#94a3b8"); line.setAttribute("stroke-width", "2");
                    line.setAttribute("stroke-dasharray", "5,5");
                    svgLayer.appendChild(line);
                }
            });
        }

        function saveConfig() {
            const ip = document.getElementById('inputIP').value;
            const mask = document.getElementById('inputMask').value;
            if (ip && !isValidIP(ip)) return alert("Format IP salah!");

            const conflict = devices.find(d => d.id !== selectedDevice.id && d.ip === ip && ip !== '');
            if (conflict) {
                document.getElementById('conflictAlert').classList.remove('hidden');
                return;
            }

            selectedDevice.ip = ip;
            selectedDevice.mask = mask;
            
            const el = document.getElementById(selectedDevice.id);
            el.querySelector('.device-ip-display').innerText = ip || 'no-ip';
            
            if (selectedDevice.type === 'PC' && ip) addPingButton(selectedDevice);
            closeModal();
            logAction(`${selectedDevice.type} IP diset ke ${ip}`, 'success');
        }

        function addPingButton(dev) {
            const el = document.getElementById(dev.id);
            const body = el.querySelector('.device-body');
            if (body.querySelector('.ping-btn')) return;

            const btn = document.createElement('button');
            btn.className = "ping-btn ping-btn-animate absolute -top-3 -right-3 bg-sky-500 text-white rounded-full p-1.5 shadow-lg z-20 border-2 border-white flex items-center justify-center";
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>';
            btn.title = "Lakukan Ping";
            btn.onclick = (e) => {
                e.stopPropagation();
                startPingFlow(dev);
            };
            body.appendChild(btn);
        }

        async function executePing(src, dest) {
            logAction(`Pinging dari ${src.ip} ke ${dest.ip || 'Unknown'}...`, 'info');
            stats.pings++;
            updateStats();

            const path = findPath(src, dest);
            if (path.length > 1) {
                // Animasi perjalanan paket
                for (let i = 0; i < path.length - 1; i++) {
                    await animatePacket(path[i], path[i+1]);
                }

                if (!dest.ip) {
                    showPingResult(false, "Destination Host Unreachable");
                } else if (isSameNetwork(src.ip, dest.ip, src.mask)) {
                    showPingResult(true, `Reply from ${dest.ip}: bytes=32 TTL=64`);
                } else if (path.some(n => n.type === 'Router')) {
                    showPingResult(true, `Reply from ${dest.ip}: bytes=32 TTL=63`);
                } else {
                    showPingResult(false, "Destination Host Unreachable (Beda Network)");
                }
            } else {
                showPingResult(false, "Request Timed Out (Tidak terhubung)");
            }
        }

        function animatePacket(from, to) {
            return new Promise(resolve => {
                const p = document.createElement('div');
                p.className = "packet absolute w-3 h-3 bg-yellow-400 rounded-full shadow-lg border border-white";
                p.style.left = `${from.x + 30}px`;
                p.style.top = `${from.y + 30}px`;
                canvas.appendChild(p);

                const start = performance.now();
                const duration = 500;

                function step(time) {
                    const progress = Math.min((time - start) / duration, 1);
                    p.style.left = `${from.x + 30 + (to.x - from.x) * progress}px`;
                    p.style.top = `${from.y + 30 + (to.y - from.y) * progress}px`;
                    if (progress < 1) requestAnimationFrame(step);
                    else { p.remove(); resolve(); }
                }
                requestAnimationFrame(step);
            });
        }

        // --- Utils ---
        function findPath(start, end) {
            let q = [[start]], visited = new Set([start.id]);
            while (q.length > 0) {
                let path = q.shift(), node = path[path.length - 1];
                if (node.id === end.id) return path;
                connections.filter(c => c.from === node.id || c.to === node.id).forEach(c => {
                    let next = devices.find(d => d.id === (c.from === node.id ? c.to : c.from));
                    if (!visited.has(next.id)) { visited.add(next.id); q.push([...path, next]); }
                });
            }
            return [];
        }

        function isSameNetwork(ip1, ip2, mask) {
            if (!ip1 || !ip2) return false;
            const o1 = ip1.split('.'), o2 = ip2.split('.'), m = mask.split('.');
            return o1.every((v, i) => (parseInt(v) & parseInt(m[i])) === (parseInt(o2[i]) & parseInt(m[i])));
        }

        function startDrag(e, dev) {
            if (isConnectingMode || isPingMode) return;
            const rect = canvas.getBoundingClientRect();
            draggingDevice = dev;
            dragOffset.x = e.clientX - rect.left - dev.x;
            dragOffset.y = e.clientY - rect.top - dev.y;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if (!draggingDevice) return;
            const rect = canvas.getBoundingClientRect();
            draggingDevice.x = e.clientX - rect.left - dragOffset.x;
            draggingDevice.y = e.clientY - rect.top - dragOffset.y;
            const el = document.getElementById(draggingDevice.id);
            el.style.left = `${draggingDevice.x}px`;
            el.style.top = `${draggingDevice.y}px`;
            drawConnections();
        }

        function stopDrag() { draggingDevice = null; document.removeEventListener('mousemove', onDrag); }
        function openConfig(dev) {
            selectedDevice = dev;
            document.getElementById('inputIP').value = dev.ip;
            document.getElementById('inputMask').value = dev.mask;
            document.getElementById('configModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('configModal').classList.add('hidden'); }
        function logAction(m, t) {
            const log = document.getElementById('ping-log');
            if (log.innerText.includes('Menunggu')) log.innerHTML = '';
            const d = document.createElement('div');
            d.className = `log-entry ${t==='success'?'text-emerald-600':t==='error'?'text-red-500':'text-slate-500'}`;
            d.innerText = `> ${m}`;
            log.prepend(d);
        }
        function showPingResult(s, t) {
            const f = document.getElementById('pingFeedback'), ft = document.getElementById('pingFeedbackText');
            f.classList.remove('hidden', 'bg-red-500', 'bg-emerald-500');
            f.classList.add(s ? 'bg-emerald-500' : 'bg-red-500');
            ft.innerText = t;
            logAction(t, s ? 'success' : 'error');
            setTimeout(() => f.classList.add('hidden'), 3000);
        }
        function isValidIP(ip) { return /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip); }
        function updateInfo(t) { infoText.innerText = t; }
        function updateStats() {
            document.getElementById('stat-devices').innerText = devices.length;
            document.getElementById('stat-pings').innerText = stats.pings;
        }
        function removeDevice(e, id) {
            e.stopPropagation();
            devices = devices.filter(d => d.id !== id);
            connections = connections.filter(c => c.from !== id && c.to !== id);
            document.getElementById(id).remove();
            drawConnections(); updateStats();
        }
        function resetSimulation() {
            devices = []; connections = []; deviceCounter = 0; stats = {devices:0, pings:0};
            canvas.querySelectorAll('.device').forEach(d => d.remove());
            svgLayer.innerHTML = '';
            document.getElementById('ping-log').innerHTML = '<div class="text-slate-400 italic">Reset...</div>';
            updateStats();
        }
        canvas.addEventListener('click', exitModes);
    </script>
</body>
</html>