<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulator Jaringan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; overflow: hidden; }
        .canvas-area { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 30px 30px; }
        .device-node { transition: all 0.2s; cursor: grab; user-select: none; }
        .device-node:active { cursor: grabbing; }
        .packet {
            width: 14px; height: 14px; background-color: #f59e0b;
            border: 2px solid white; border-radius: 50%;
            position: absolute; z-index: 50; 
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.8);
        }
        .connection-line { cursor: pointer; pointer-events: all; }
        .connection-hitbox { cursor: pointer; pointer-events: all; stroke: transparent; stroke-width: 15px; }
        .connection-hitbox:hover + .connection-line { stroke: #6366f1; stroke-width: 3px; }
        
        @keyframes pulse-ring { 
            0% { transform: scale(0.8); opacity: 0.5; } 
            100% { transform: scale(1.5); opacity: 0; } 
        }
        .active-route::before {
            content: ''; position: absolute; width: 100%; height: 100%;
            border: 4px solid #10b981; border-radius: inherit;
            animation: pulse-ring 1.5s infinite;
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b px-8 py-4 flex justify-between items-center shrink-0 z-50">
        <div class="flex items-center gap-4">
            <div class="p-2 bg-indigo-600 rounded-xl">
                <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h1 class="text-xl font-bold text-slate-800">Simulator<span class="text-indigo-600">Jaringan</span></h1>
        </div>
        
        <div class="flex items-center gap-3 bg-slate-100 p-1 rounded-xl border">
            <button onclick="setTool('select')" id="tool-select" class="tool-btn px-4 py-1.5 rounded-lg text-sm font-medium bg-white shadow-sm text-indigo-600">Pilih</button>
            <button onclick="setTool('cable')" id="tool-cable" class="tool-btn px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500">Kabel</button>
            <button onclick="setTool('ping')" id="tool-ping" class="tool-btn px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500">Uji Ping</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar Perangkat -->
        <aside class="w-24 bg-white border-r flex flex-col items-center py-8 gap-8 z-40">
            <div onclick="spawnDevice('pc')" class="group cursor-pointer flex flex-col items-center gap-1" title="Tambah PC">
                <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                </div>
                <span class="text-[10px] font-bold text-slate-400 uppercase">PC</span>
            </div>
            <div onclick="spawnDevice('router')" class="group cursor-pointer flex flex-col items-center gap-1" title="Tambah Router">
                <div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-all shadow-sm">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                </div>
                <span class="text-[10px] font-bold text-slate-400 uppercase">Router</span>
            </div>
            <div onclick="spawnDevice('switch')" class="group cursor-pointer flex flex-col items-center gap-1" title="Tambah Switch">
                <div class="w-12 h-12 bg-purple-50 rounded-xl flex items-center justify-center text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-all shadow-sm">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                </div>
                <span class="text-[10px] font-bold text-slate-400 uppercase">Switch</span>
            </div>
        </aside>

        <!-- Workspace -->
        <section id="workspace" class="flex-1 relative canvas-area bg-slate-50 overflow-hidden">
            <!-- Layers -->
            <svg id="connection-layer" class="absolute inset-0 w-full h-full" style="pointer-events: none;"></svg>
            
            <!-- Quick Tip Box -->
            <div id="quick-tip" class="absolute top-6 left-6 w-72 bg-white/90 backdrop-blur p-4 rounded-2xl border border-slate-200 shadow-xl z-30">
                <div class="flex items-start gap-3">
                    <div class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-indigo-600 uppercase mb-1">Tips Edukasi</h4>
                        <p id="tip-text" class="text-[11px] text-slate-600">Klik dua kali pada perangkat untuk konfigurasi. Klik kanan pada perangkat atau kabel untuk menghapusnya.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sidebar Log -->
        <aside class="w-72 bg-white border-l flex flex-col z-40">
            <div class="p-4 border-b font-bold text-xs text-slate-500 uppercase tracking-widest">Aktivitas Jaringan</div>
            <div id="traffic-log" class="flex-1 overflow-y-auto p-4 space-y-2 font-mono text-[10px]"></div>
        </aside>
    </main>

    <!-- Configuration Modal -->
    <div id="config-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg overflow-hidden shadow-2xl">
            <!-- Header Modal -->
            <div id="modal-header" class="p-6 text-white flex justify-between items-center">
                <div>
                    <h3 id="modal-title" class="text-xl font-bold">Konfigurasi Perangkat</h3>
                    <p id="modal-subtitle" class="text-xs opacity-80">Atur parameter Layer 3 Anda</p>
                </div>
                <button onclick="closeModal()" class="hover:bg-white/20 p-2 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b bg-slate-50">
                <button onclick="switchTab('ip')" id="tab-ip-btn" class="px-6 py-3 text-xs font-bold border-b-2 border-indigo-600 text-indigo-600">Konfigurasi IP</button>
                <button onclick="switchTab('route')" id="tab-route-btn" class="hidden px-6 py-3 text-xs font-bold text-slate-400">Tabel Routing</button>
            </div>

            <!-- Content: IP Config -->
            <div id="tab-ip-content" class="p-6 space-y-6">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Alamat IP (IPv4)</label>
                        <input type="text" id="input-ip" placeholder="192.168.1.10" class="w-full px-4 py-2.5 bg-slate-100 border border-transparent rounded-xl font-mono focus:bg-white focus:border-indigo-300 outline-none transition-all">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Subnet Mask</label>
                        <input type="text" id="input-mask" placeholder="255.255.255.0" class="w-full px-4 py-2.5 bg-slate-100 border border-transparent rounded-xl font-mono focus:bg-white focus:border-indigo-300 outline-none transition-all">
                    </div>
                    <div id="gw-field">
                        <label class="text-[10px] font-bold text-orange-500 uppercase block mb-1">Default Gateway</label>
                        <input type="text" id="input-gw" placeholder="192.168.1.1" class="w-full px-4 py-2.5 bg-orange-50 border border-transparent rounded-xl font-mono focus:bg-white focus:border-orange-300 outline-none transition-all">
                    </div>
                </div>

                <!-- Analisis Edukatif -->
                <div class="p-4 rounded-2xl border border-slate-100 bg-slate-50 space-y-3">
                    <h4 class="text-[10px] font-bold text-indigo-600 uppercase">Hasil Analisis Subnetting</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                            <span class="block text-[9px] text-slate-400 uppercase font-bold">Network ID</span>
                            <span id="display-netid" class="text-sm font-mono font-bold text-indigo-600">--</span>
                        </div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                            <span class="block text-[9px] text-slate-400 uppercase font-bold">Host ID</span>
                            <span id="display-hostid" class="text-sm font-mono font-bold text-emerald-600">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content: Routing Table -->
            <div id="tab-route-content" class="hidden p-6 max-h-80 overflow-y-auto">
                <div class="mb-4 text-[10px] text-slate-500 italic">Tabel ini terisi secara otomatis berdasarkan interface yang aktif (Directly Connected).</div>
                <table class="w-full text-left text-[11px] font-mono">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="p-2 rounded-l-lg">Network</th>
                            <th class="p-2">Mask</th>
                            <th class="p-2 rounded-r-lg">Next Hop</th>
                        </tr>
                    </thead>
                    <tbody id="routing-table-body" class="divide-y"></tbody>
                </table>
            </div>

            <div class="p-6 bg-slate-50 flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-xl transition-colors">Batal</button>
                <button onclick="saveConfig()" class="flex-1 py-3 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-lg shadow-indigo-100 transition-all">Simpan Konfigurasi</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="ctx-menu" class="hidden absolute z-[200] bg-white border rounded-xl shadow-xl w-48 overflow-hidden py-1">
        <div id="ctx-target-info" class="px-4 py-2 text-[10px] font-bold text-slate-400 uppercase border-b bg-slate-50 mb-1">Target</div>
        <button id="ctx-btn-delete" onclick="handleContextDelete()" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            Hapus
        </button>
    </div>

    <script>
        // State
        let devices = [];
        let connections = [];
        let tool = 'select';
        let idCounter = 0;
        let cableSrc = null;
        let pingSrc = null;
        
        let contextTarget = { type: null, id: null }; // Tracks what was right-clicked

        const workspace = document.getElementById('workspace');
        const connLayer = document.getElementById('connection-layer');

        // Core Functions
        function setTool(t) {
            tool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('bg-white','shadow-sm','text-indigo-600'));
            document.getElementById(`tool-${t}`).classList.add('bg-white','shadow-sm','text-indigo-600');
            cableSrc = null; pingSrc = null;
            document.querySelectorAll('.device-node').forEach(d => d.classList.remove('ring-4', 'ring-indigo-400', 'ring-orange-400'));
            updateTip();
        }

        function updateTip() {
            const tips = {
                select: "Klik dua kali perangkat untuk konfigurasi. Klik kanan perangkat/kabel untuk hapus.",
                cable: "Klik perangkat pertama, lalu klik perangkat kedua untuk menghubungkan.",
                ping: "Klik PC sumber, lalu klik PC tujuan untuk simulasi pengiriman paket."
            };
            document.getElementById('tip-text').innerText = tips[tool];
        }

        function spawnDevice(type) {
            const id = `dev_${++idCounter}`;
            const dev = {
                id, type, name: `${type.toUpperCase()} ${idCounter}`,
                x: 150 + Math.random()*100, y: 150 + Math.random()*100,
                ip: '', mask: '255.255.255.0', gw: '',
                routes: []
            };
            devices.push(dev);
            renderDevice(dev);
            log(`Perangkat ${dev.name} ditambahkan.`, 'info');
        }

        function renderDevice(dev) {
            const el = document.createElement('div');
            el.id = dev.id;
            el.className = `device-node absolute w-16 h-16 bg-white rounded-2xl shadow-md border-2 border-slate-100 flex flex-col items-center justify-center z-10`;
            el.style.left = `${dev.x}px`; el.style.top = `${dev.y}px`;
            
            const color = dev.type === 'pc' ? 'text-blue-500' : (dev.type === 'router' ? 'text-emerald-500' : 'text-purple-500');
            const icon = {
                pc: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>',
                router: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>',
                switch: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>'
            }[dev.type];

            el.innerHTML = `
                <div class="${color}">${icon}</div>
                <div class="absolute -bottom-8 text-center w-32">
                    <div class="text-[10px] font-bold text-slate-800">${dev.name}</div>
                    <div class="text-[9px] font-mono text-indigo-500 font-bold" id="${dev.id}-lbl-ip">${dev.ip || ''}</div>
                </div>
            `;

            let isDrag = false; let off = {x:0, y:0};
            el.onmousedown = (e) => {
                if (tool !== 'select' || e.button !== 0) return;
                isDrag = true; off = { x: e.clientX - dev.x, y: e.clientY - dev.y };
                e.stopPropagation();
            };
            window.addEventListener('mousemove', (e) => {
                if (!isDrag) return;
                dev.x = e.clientX - off.x; dev.y = e.clientY - off.y;
                el.style.left = `${dev.x}px`; el.style.top = `${dev.y}px`;
                drawConnections();
            });
            window.addEventListener('mouseup', () => isDrag = false);

            el.onclick = (e) => {
                e.stopPropagation();
                if (tool === 'cable') handleCable(dev.id);
                else if (tool === 'ping') handlePing(dev.id);
                else openModal(dev.id);
            };

            el.oncontextmenu = (e) => {
                e.preventDefault(); e.stopPropagation();
                showContextMenu(e, 'device', dev.id, dev.name);
            };

            workspace.appendChild(el);
        }

        // Logic Kabel
        function handleCable(id) {
            if (!cableSrc) { cableSrc = id; document.getElementById(id).classList.add('ring-4', 'ring-indigo-400'); }
            else if (cableSrc !== id) {
                if (!connections.some(c => (c.a === cableSrc && c.b === id) || (c.a === id && c.b === cableSrc))) {
                    connections.push({ id: `conn_${Date.now()}`, a: cableSrc, b: id });
                    drawConnections();
                    log(`Kabel terhubung: ${getDev(cableSrc).name} - ${getDev(id).name}`, 'info');
                    updateAllRoutes();
                }
                document.getElementById(cableSrc).classList.remove('ring-4', 'ring-indigo-400');
                cableSrc = null;
            }
        }

        function drawConnections() {
            connLayer.innerHTML = '';
            connections.forEach((c, index) => {
                const d1 = getDev(c.a), d2 = getDev(c.b);
                if (!d1 || !d2) return;

                // Hitbox transparan untuk memudahkan klik kanan pada kabel
                const hitbox = document.createElementNS("http://www.w3.org/2000/svg", "line");
                hitbox.setAttribute("x1", d1.x+32); hitbox.setAttribute("y1", d1.y+32);
                hitbox.setAttribute("x2", d2.x+32); hitbox.setAttribute("y2", d2.y+32);
                hitbox.setAttribute("class", "connection-hitbox");
                hitbox.oncontextmenu = (e) => {
                    e.preventDefault(); e.stopPropagation();
                    showContextMenu(e, 'cable', c.id, `Kabel ${d1.name}-${d2.name}`);
                };

                // Garis visual
                const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                l.setAttribute("x1", d1.x+32); l.setAttribute("y1", d1.y+32);
                l.setAttribute("x2", d2.x+32); l.setAttribute("y2", d2.y+32);
                l.setAttribute("stroke", "#cbd5e1"); l.setAttribute("stroke-width", "2");
                l.setAttribute("class", "connection-line");
                l.style.pointerEvents = "none";

                connLayer.appendChild(hitbox);
                connLayer.appendChild(l);
            });
        }

        // Context Menu Management
        function showContextMenu(e, type, id, label) {
            contextTarget = { type, id };
            const m = document.getElementById('ctx-menu');
            document.getElementById('ctx-target-info').innerText = label;
            document.getElementById('ctx-btn-delete').innerText = type === 'device' ? 'Hapus Perangkat' : 'Hapus Kabel';
            
            m.style.left = `${e.clientX}px`; m.style.top = `${e.clientY}px`;
            m.classList.remove('hidden');
        }

        function handleContextDelete() {
            if (contextTarget.type === 'device') {
                deleteDevice(contextTarget.id);
            } else if (contextTarget.type === 'cable') {
                deleteCable(contextTarget.id);
            }
            document.getElementById('ctx-menu').classList.add('hidden');
        }

        function deleteDevice(id) {
            const dev = getDev(id);
            if (!dev) return;
            devices = devices.filter(d => d.id !== id);
            connections = connections.filter(c => c.a !== id && c.b !== id);
            const el = document.getElementById(id);
            if (el) el.remove();
            drawConnections();
            updateAllRoutes();
            log(`Perangkat ${dev.name} dihapus.`, 'info');
        }

        function deleteCable(connId) {
            const conn = connections.find(c => c.id === connId);
            if (!conn) return;
            const d1 = getDev(conn.a), d2 = getDev(conn.b);
            connections = connections.filter(c => c.id !== connId);
            drawConnections();
            updateAllRoutes();
            log(`Kabel ${d1.name}-${d2.name} dilepas.`, 'info');
        }

        // Modal Config Logic
        function openModal(id) {
            contextTarget = { type: 'device', id: id };
            const dev = getDev(id);
            document.getElementById('modal-header').className = `p-6 text-white ${dev.type==='pc'?'bg-blue-600':(dev.type==='router'?'bg-emerald-600':'bg-purple-600')}`;
            document.getElementById('modal-title').innerText = `Konfigurasi ${dev.name}`;
            document.getElementById('input-ip').value = dev.ip;
            document.getElementById('input-mask').value = dev.mask;
            document.getElementById('input-gw').value = dev.gw;
            document.getElementById('gw-field').style.display = dev.type === 'pc' ? 'block' : 'none';
            document.getElementById('tab-route-btn').classList.toggle('hidden', dev.type !== 'router');
            
            updateAnalysis();
            switchTab('ip');
            document.getElementById('config-modal').classList.remove('hidden');
        }

        function updateAnalysis() {
            const ip = document.getElementById('input-ip').value;
            const mask = document.getElementById('input-mask').value;
            if (isValidIP(ip) && isValidIP(mask)) {
                document.getElementById('display-netid').innerText = getNetwork(ip, mask);
                document.getElementById('display-hostid').innerText = getHost(ip, mask);
            } else {
                document.getElementById('display-netid').innerText = "--";
                document.getElementById('display-hostid').innerText = "--";
            }
        }

        document.getElementById('input-ip').oninput = updateAnalysis;
        document.getElementById('input-mask').oninput = updateAnalysis;

        function saveConfig() {
            const dev = getDev(contextTarget.id);
            dev.ip = document.getElementById('input-ip').value;
            dev.mask = document.getElementById('input-mask').value;
            dev.gw = document.getElementById('input-gw').value;
            document.getElementById(`${dev.id}-lbl-ip`).innerText = dev.ip;
            updateAllRoutes();
            closeModal();
            log(`Konfigurasi ${dev.name} disimpan.`, 'success');
        }

        function switchTab(t) {
            const isIp = t === 'ip';
            document.getElementById('tab-ip-content').classList.toggle('hidden', !isIp);
            document.getElementById('tab-route-content').classList.toggle('hidden', isIp);
            document.getElementById('tab-ip-btn').className = isIp ? 'px-6 py-3 text-xs font-bold border-b-2 border-indigo-600 text-indigo-600' : 'px-6 py-3 text-xs font-bold text-slate-400';
            document.getElementById('tab-route-btn').className = !isIp ? 'px-6 py-3 text-xs font-bold border-b-2 border-emerald-600 text-emerald-600' : 'px-6 py-3 text-xs font-bold text-slate-400';
            if (t === 'route') renderRoutingTable();
        }

        function renderRoutingTable() {
            const dev = getDev(contextTarget.id);
            const body = document.getElementById('routing-table-body');
            body.innerHTML = dev.routes.map(r => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 font-bold text-indigo-600">${r.network}</td>
                    <td class="p-2 text-slate-500">${r.mask}</td>
                    <td class="p-2 text-emerald-600 font-bold">${r.nextHop}</td>
                </tr>
            `).join('');
            if (!dev.routes.length) body.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400 italic">Router belum terhubung ke jaringan manapun.</td></tr>';
        }

        function updateAllRoutes() {
            devices.forEach(d => {
                if (d.type === 'router') {
                    d.routes = [];
                    const neighbors = getNeighbors(d.id);
                    neighbors.forEach(n => {
                        if (n.ip && n.mask) {
                            const net = getNetwork(n.ip, n.mask);
                            if (!d.routes.some(r => r.network === net)) {
                                d.routes.push({ network: net, mask: n.mask, nextHop: 'Directly Connected' });
                            }
                        }
                    });
                }
            });
        }

        function getNeighbors(id) {
            let direct = connections.filter(c => c.a === id || c.b === id).map(c => c.a === id ? c.b : c.a);
            let results = [], visited = new Set(), queue = [...direct];
            while(queue.length > 0) {
                let current = queue.shift();
                if (visited.has(current)) continue;
                visited.add(current);
                let d = getDev(current);
                if (!d) continue;
                if (d.type === 'switch') {
                    let next = connections.filter(c => c.a === current || c.b === current).map(c => c.a === current ? c.b : c.a);
                    queue.push(...next);
                } else { results.push(d); }
            }
            return results;
        }

        // Simulasi Ping
        function handlePing(id) {
            if (!pingSrc) { pingSrc = id; document.getElementById(id).classList.add('ring-4', 'ring-orange-400'); }
            else if (pingSrc !== id) {
                const s = getDev(pingSrc), d = getDev(id);
                document.getElementById(pingSrc).classList.remove('ring-4', 'ring-orange-400');
                if (!s.ip || !d.ip) return log("Error: IP belum dikonfigurasi.", 'error');
                
                log(`Mencoba Ping dari ${s.name} ke ${d.name}...`, 'info');
                
                const sNet = getNetwork(s.ip, s.mask);
                const dNet = getNetwork(d.ip, d.mask);
                
                let validRoute = false;
                if (sNet === dNet) validRoute = true;
                else if (s.gw) {
                    const gwR = devices.find(x => x.ip === s.gw && x.type === 'router');
                    if (gwR && areConnected(s.id, gwR.id)) {
                        if (gwR.routes.some(r => r.network === dNet)) validRoute = true;
                    }
                }

                const physicalPath = findPath(pingSrc, id);
                if (physicalPath.length > 0 && validRoute) {
                    animatePacket(physicalPath, () => log(`Reply from ${d.ip}: success!`, 'success'));
                } else {
                    log(`Request Timed Out. ${!validRoute ? '(Masalah Routing/Gateway)' : '(Masalah Fisik/Kabel)'}`, 'error');
                }
                pingSrc = null;
            }
        }

        function findPath(start, end) {
            let q = [[start]], v = new Set();
            while(q.length > 0) {
                let path = q.shift(), n = path[path.length-1];
                if (n === end) return path;
                if (!v.has(n)) {
                    v.add(n);
                    connections.forEach(c => {
                        if (c.a === n) q.push([...path, c.b]);
                        if (c.b === n) q.push([...path, c.a]);
                    });
                }
            }
            return [];
        }

        function areConnected(a, b) { return findPath(a, b).length > 0; }

        function animatePacket(path, cb) {
            const p = document.createElement('div'); p.className = 'packet'; workspace.appendChild(p);
            let i = 0;
            function move() {
                if (i >= path.length-1) { p.remove(); cb(); return; }
                const from = getDev(path[i]), to = getDev(path[i+1]);
                let prog = 0;
                const anim = setInterval(() => {
                    prog += 5;
                    p.style.left = `${from.x+32 + (to.x-from.x)*(prog/100) - 7}px`;
                    p.style.top = `${from.y+32 + (to.y-from.y)*(prog/100) - 7}px`;
                    if (prog >= 100) { clearInterval(anim); i++; move(); }
                }, 25);
            }
            move();
        }

        // Helpers
        function getDev(id) { return devices.find(d => d.id === id); }
        function isValidIP(ip) { return /^(\d{1,3}\.){3}\d{1,3}$/.test(ip); }
        function getNetwork(ip, mask) {
            const i = ip.split('.'), m = mask.split('.');
            return i.map((v, idx) => v & m[idx]).join('.');
        }
        function getHost(ip, mask) {
            const i = ip.split('.'), m = mask.split('.');
            return i.map((v, idx) => v & (~m[idx] & 255)).join('.');
        }
        function log(m, t) {
            const c = { info: 'text-slate-500', success: 'text-emerald-600 font-bold', error: 'text-red-500' };
            const l = document.getElementById('traffic-log');
            const e = document.createElement('div'); e.className = `p-2 border-b border-slate-50 ${c[t]}`;
            e.innerHTML = `<span class="opacity-40">[${new Date().toLocaleTimeString()}]</span> ${m}`;
            l.prepend(e);
        }
        function closeModal() { document.getElementById('config-modal').classList.add('hidden'); }
        
        window.onclick = (e) => {
            document.getElementById('ctx-menu').classList.add('hidden');
            if (tool === 'select' && e.target.id === 'workspace') {
                cableSrc = null; pingSrc = null;
                document.querySelectorAll('.device-node').forEach(d => d.classList.remove('ring-4', 'ring-indigo-400', 'ring-orange-400'));
            }
        };

        updateTip();
    </script>
</body>
</html>
