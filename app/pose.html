<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoseMorph: AI Pose Transformation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f9fafb; /* Light mode background */
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --text-dark: #111827;
            --text-medium: #374151;
            --text-light: #6b7280;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-medium);
        }
        .clean-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .tag {
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .tag.active {
            background-color: var(--accent-primary);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            border-color: var(--accent-primary);
        }
        .custom-input {
            background-color: #f3f4f6;
            border: 1px solid var(--border-color);
            color: var(--text-dark);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .custom-input::placeholder {
            color: var(--text-light);
        }
        .custom-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Before-After Slider Styles */
        #comparison-container {
            position: relative;
            width: 100%;
            max-width: 90vw;
            max-height: 80vh;
            aspect-ratio: 1/1;
            overflow: hidden;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }
        #comparison-container img {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover; pointer-events: none;
        }
        #comparison-after { clip-path: inset(0 50% 0 0); }
        #comparison-slider {
            position: absolute; -webkit-appearance: none; appearance: none;
            width: 100%; height: 100%; background: transparent;
            outline: none; margin: 0; top: 0; left: 0; cursor: col-resize;
        }
        #comparison-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 6px; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            cursor: col-resize;
            border-left: 2px solid var(--accent-primary);
            border-right: 2px solid var(--accent-primary);
        }
        #comparison-slider::-moz-range-thumb {
            width: 6px; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            cursor: col-resize; border: 0; border-radius: 0;
        }
    </style>
</head>
<body class="min-h-screen w-full p-4 lg:p-8">

    <main class="w-full max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-indigo-500 to-purple-500 text-transparent bg-clip-text pb-2">PoseMorph</h1>
            <p class="text-gray-500 text-lg">Platform Kreasi Pose Berbasis AI dengan Kontrol Penuh.</p>
        </header>

        <!-- Main Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
            <!-- Controls Section -->
            <div class="lg:col-span-2 space-y-6 sticky top-8">
                <div class="clean-card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 flex items-center"><span class="bg-indigo-500 text-white text-sm rounded-full h-6 w-6 flex items-center justify-center mr-3">1</span> Unggah Foto</h2>
                    <div id="image-upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-50 transition-all duration-300">
                        <input type="file" id="image-uploader" class="hidden" accept="image/*">
                        <div id="upload-prompt">
                             <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                            <p class="mt-2 text-gray-600">Klik untuk memilih file</p>
                            <p class="text-xs text-gray-400">PNG, JPG, WEBP (Maks. 4MB)</p>
                        </div>
                        <img id="image-preview" src="" alt="Pratinjau Gambar" class="hidden max-h-60 mx-auto rounded-lg"/>
                    </div>
                </div>

                <div class="clean-card p-6 space-y-6">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center"><span class="bg-indigo-500 text-white text-sm rounded-full h-6 w-6 flex items-center justify-center mr-3">2</span> Kustomisasi</h2>
                    <div>
                        <h3 class="font-medium mb-3 text-gray-700">Pilih Gaya</h3>
                        <div id="style-selector" class="flex flex-wrap gap-2">
                            <button class="tag style-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full" data-style="Potret Studio">Potret Studio</button>
                            <button class="tag style-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full" data-style="Gym Fitness">Gym Fitness</button>
                            <button class="tag style-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full" data-style="Travel Blogger">Travel</button>
                            <button class="tag style-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full" data-style="Futuristik Cyberpunk">Futuristik</button>
                            <button class="tag style-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full" data-style="Fantasi Elf">Fantasi</button>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-medium mb-3 text-gray-700">Atau Tulis Gaya & Latar Kustom</h3>
                        <div class="space-y-3">
                             <input id="custom-style-input" type="text" placeholder="Gaya: lukisan cat minyak, pahlawan super" class="w-full custom-input rounded-lg p-2.5 placeholder-gray-400">
                             <input id="custom-background-input" type="text" placeholder="Latar: pantai saat senja, kota tokyo" class="w-full custom-input rounded-lg p-2.5 placeholder-gray-400">
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium mb-3 text-gray-700">Jumlah Gambar</h3>
                         <div id="count-selector" class="flex flex-wrap gap-2">
                            <button class="tag count-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full" data-count="4">4</button>
                            <button class="tag count-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full active" data-count="8">8</button>
                            <button class="tag count-tag bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full" data-count="12">12</button>
                        </div>
                    </div>
                </div>
                
                <div class="clean-card p-6">
                     <h2 class="text-xl font-semibold mb-4 text-gray-900 flex items-center"><span class="bg-indigo-500 text-white text-sm rounded-full h-6 w-6 flex items-center justify-center mr-3">3</span> Hasilkan</h2>
                    <button id="generate-button" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100 disabled:bg-none flex items-center justify-center space-x-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527-1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/></svg>
                         <span>Buat Variasi Pose</span>
                    </button>
                </div>
                 <div id="message-box" class="hidden p-4 rounded-lg text-center"></div>
            </div>

            <!-- Results Section -->
            <div class="lg:col-span-3">
                <div class="clean-card p-6 min-h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Hasil Kreasi</h2>
                        <button id="suggestion-button" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-2 px-4 rounded-lg text-sm transition-all transform hover:scale-105 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m6.93.024c.253.114.495.26.727.425l.2.162c.235.197.45.43.648.687.218.28.398.59.548.92.144.318.257.658.336.998.04.17.07.345.094.524.025.183.04.37.046.56.006.188.007.377.006.566a8.01 8.01 0 0 0-.01-1.123C11.531 6.3 11 5.37 10.052 4.6l-.2-.162c-.235-.197-.45-.43-.648-.687-.218-.28-.398-.59-.548-.92-.144-.318-.257-.658-.336-.998a1.94 1.94 0 0 1-.094-.524C8.25 1.024 8.125.75 8 .5c-.125-.25-.25-.524-.372-.774a1.94 1.94 0 0 1-.094-.524c-.08-.34-.192-.68-.336-.998-.15-.33-.33-.648-.548-.92-.198-.257-.413-.49-.648-.687l-.2-.162C5.053 1.63 4.5 2.56 4.01 3.784c-.006.188-.007.377-.006.566.005.19.02.377.046.56.024.179.054.354.094.524.08.34.192.68.336.998.15.33.33.648.548.92.198.257.413.49.648.687l.2.162c.232.165.474.31.727.425z"/></svg>
                            <span>Inspirasi Pose</span>
                        </button>
                    </div>
                    <div id="image-loader" class="hidden flex-col items-center justify-center py-16"><div class="spinner"></div><p class="mt-4 text-gray-500">AI sedang bekerja... Mohon tunggu.</p></div>
                    <div id="image-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    <div id="suggestion-area" class="hidden mt-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Saran Pose Kreatif</h3>
                        <div id="suggestion-loader" class="hidden flex items-center justify-center py-6"><div class="spinner !w-24 !h-24"></div></div>
                        <div id="suggestion-content" class="bg-gray-100 p-4 rounded-lg text-gray-600 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300">
        <div class="relative bg-white p-4 rounded-xl max-w-4xl w-auto max-h-full flex flex-col items-center shadow-2xl space-y-4">
             <!-- Comparison Slider Component -->
            <div id="comparison-container">
                <img id="comparison-before" src="" alt="Before">
                <img id="comparison-after" src="" alt="After">
                <input type="range" min="0" max="100" value="50" id="comparison-slider" aria-label="Perbandingan Gambar">
            </div>
            <div class="flex items-center space-x-4">
                 <button id="lightbox-download" class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                    <span>Unduh Gambar</span>
                </button>
            </div>
            <button id="lightbox-close" class="absolute -top-3 -right-3 text-gray-600 bg-white rounded-full w-8 h-8 flex items-center justify-center text-2xl font-bold hover:bg-red-500 hover:text-white transition-colors shadow-lg border">&times;</button>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const imageUploader = document.getElementById('image-uploader');
        const imageUploadArea = document.getElementById('image-upload-area');
        const uploadPrompt = document.getElementById('upload-prompt');
        const imagePreview = document.getElementById('image-preview');
        const generateButton = document.getElementById('generate-button');
        const suggestionButton = document.getElementById('suggestion-button');
        const imageLoader = document.getElementById('image-loader');
        const imageGrid = document.getElementById('image-grid');
        const messageBox = document.getElementById('message-box');
        const styleSelector = document.getElementById('style-selector');
        const countSelector = document.getElementById('count-selector');
        const customStyleInput = document.getElementById('custom-style-input');
        const customBackgroundInput = document.getElementById('custom-background-input');
        const lightbox = document.getElementById('lightbox');
        const lightboxClose = document.getElementById('lightbox-close');
        const lightboxDownload = document.getElementById('lightbox-download');
        const comparisonBeforeImg = document.getElementById('comparison-before');
        const comparisonAfterImg = document.getElementById('comparison-after');
        const comparisonSlider = document.getElementById('comparison-slider');
        const suggestionArea = document.getElementById('suggestion-area');
        const suggestionLoader = document.getElementById('suggestion-loader');
        const suggestionContent = document.getElementById('suggestion-content');
        
        // --- State ---
        let originalImageBase64 = null;
        let isGenerating = false;
        let imageCount = 8;

        // --- API Config ---
        const apiKey = "";
        const imageModel = 'gemini-2.5-flash-image-preview';
        const textModel = 'gemini-2.5-flash-preview-05-20';
        const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/${imageModel}:generateContent?key=${apiKey}`;
        const textUrl = `https://generativelanguage.googleapis.com/v1beta/models/${textModel}:generateContent?key=${apiKey}`;
        
        const POSE_IDEAS = ["thoughtful, looking away", "joyful and laughing", "confident power pose", "playful and energetic", "dramatic with strong shadows", "elegant and poised", "curious, leaning in", "serene and calm", "powerful action shot", "friendly and welcoming", "artistic and abstract", "superhero landing"];
        
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `p-4 rounded-lg text-center text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 4 * 1024 * 1024) {
                showMessage('Ukuran file terlalu besar. Maksimal 4MB.');
                return;
            }
            const reader = new FileReader();
            reader.onloadend = () => {
                originalImageBase64 = reader.result.split(',')[1];
                imagePreview.src = reader.result;
                imagePreview.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
                generateButton.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function base64ToBlob(base64, contentType = 'image/png') {
            const byteCharacters = atob(base64.split(',')[1]);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) { byteNumbers[i] = slice.charCodeAt(i); }
                byteArrays.push(new Uint8Array(byteNumbers));
            }
            return new Blob(byteArrays, {type: contentType});
        }

        async function generateImage(base64Data, prompt, retries = 3, delay = 1000) {
            const payload = {
                contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Data } } ] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };
            try {
                const response = await fetch(imageUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    if (response.status === 429 || response.status >= 500) { throw new Error(`Server error: ${response.status}`); }
                    const errorBody = await response.json();
                    console.error("API Error:", errorBody);
                    showMessage(`Error: ${errorBody.error?.message || 'Unknown API error'}`);
                    return null;
                }
                const result = await response.json();
                return result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data || null;
            } catch (error) {
                console.error(`Attempt failed: ${error.message}. Retrying...`);
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateImage(base64Data, prompt, retries - 1, delay * 2);
                }
                return null;
            }
        }
        
        async function handleGeneration(baseImage = originalImageBase64, isIteration = false) {
            if (!baseImage) {
                showMessage('Silakan unggah gambar terlebih dahulu.');
                return;
            }
            if (isGenerating) return;

            isGenerating = true;
            generateButton.disabled = true;
            generateButton.querySelector('span').textContent = 'Memproses...';
            imageLoader.style.display = 'flex';
            if (!isIteration) imageGrid.innerHTML = '';
            suggestionArea.classList.add('hidden');

            const selectedStyles = Array.from(styleSelector.querySelectorAll('.active')).map(b => b.dataset.style);
            const customStyle = customStyleInput.value.trim();
            const customBackground = customBackgroundInput.value.trim();
            
            let stylePromptPart = '';
            const allStyles = [...selectedStyles, customStyle].filter(Boolean);
            if (allStyles.length > 0) stylePromptPart = `, with a style of: ${allStyles.join(', ')}`;
            if (customBackground) stylePromptPart += `. The background should be: ${customBackground}`;

            const prompts = POSE_IDEAS.sort(() => 0.5 - Math.random()).slice(0, imageCount);
            const generationPromises = prompts.map(idea => {
                 const fullPrompt = `Recreate the person from the image into a new pose. The new pose is: a ${idea}. Crucially, maintain the exact same facial features, hair, and identity of the person. Only the body pose and background can change. ${stylePromptPart}.`;
                 return generateImage(baseImage, fullPrompt);
            });
            
            const results = await Promise.all(generationPromises);
            
            const newImagesData = [];
            results.forEach((base64Data) => {
                if (base64Data) {
                    const newImage = {
                        imgSrc: `data:image/png;base64,${base64Data}`,
                        base64ForIterate: base64Data
                    };
                    newImagesData.push(newImage);
                    displayImage(newImage);
                }
            });
            
            if (newImagesData.length === 0) showMessage('Gagal membuat variasi. Coba lagi dengan gambar/prompt lain.');
            
            isGenerating = false;
            generateButton.disabled = false;
            generateButton.querySelector('span').textContent = 'Buat Variasi Pose';
            imageLoader.style.display = 'none';
        }
        
        function displayImage(imageData) {
            const container = document.createElement('div');
            container.className = "relative group overflow-hidden rounded-xl shadow-lg cursor-pointer";
            container.onclick = () => openLightbox(imageData);

            const img = document.createElement('img');
            img.src = imageData.imgSrc;
            img.alt = "Generated Pose";
            img.className = "w-full h-auto object-cover rounded-xl transition-transform duration-300 group-hover:scale-105";

            const iterateButton = document.createElement('button');
            iterateButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.5A4.5 4.5 0 0 0 8 3zM3.5 9a4.5 4.5 0 0 0 9 0H14a6 6 0 0 1-11.857-2.182.5.5 0 1 1 .771.636A5.002 5.002 0 0 0 8 13c1.552 0 2.94-.707 3.857-1.818a.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.5z"/></svg>`;
            iterateButton.className = "absolute top-2 right-2 bg-white/60 backdrop-blur-sm text-gray-800 p-2.5 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-300 transform hover:scale-110";
            iterateButton.title = "Buat yang Mirip";
            iterateButton.onclick = (e) => {
                e.stopPropagation();
                handleGeneration(imageData.base64ForIterate, true);
            };

            container.append(img, iterateButton);
            imageGrid.appendChild(container);
        }

        async function getPoseSuggestions() {
            suggestionArea.classList.remove('hidden');
            suggestionContent.innerHTML = '';
            suggestionLoader.style.display = 'flex';
            const payload = { contents: [{ parts: [{ text: "Berikan 10 ide pose foto potret yang kreatif, unik, dan bervariasi. Gunakan format daftar bernomor dan berikan deskripsi singkat untuk setiap pose." }] }] };
            try {
                const response = await fetch(textUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("Gagal mengambil saran.");
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if(text) {
                     // Simple markdown to HTML
                    let html = text.replace(/^\d+\.\s/gm, (match) => `<br><strong>${match}</strong>`);
                    suggestionContent.innerHTML = html;
                }
                else throw new Error("Respon AI kosong.");
            } catch (error) {
                suggestionContent.innerHTML = `<p class="text-red-400">${error.message}</p>`;
            } finally {
                suggestionLoader.style.display = 'none';
            }
        }

        function openLightbox(imageData) {
            comparisonBeforeImg.src = `data:image/jpeg;base64,${originalImageBase64}`;
            comparisonAfterImg.src = imageData.imgSrc;
            comparisonSlider.value = 50;
            comparisonAfterImg.style.clipPath = 'inset(0 50% 0 0)';
            lightbox.classList.remove('hidden');
        }

        function closeLightbox() { lightbox.classList.add('hidden'); }

        function handleDownload() {
            const base64Image = comparisonAfterImg.src;
            if (!base64Image) return;
            const blob = base64ToBlob(base64Image);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PoseMorph_${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // --- Event Listeners ---
        imageUploadArea.addEventListener('click', () => imageUploader.click());
        imageUploader.addEventListener('change', handleImageUpload);
        generateButton.addEventListener('click', () => handleGeneration(originalImageBase64, false));
        suggestionButton.addEventListener('click', getPoseSuggestions);
        lightboxClose.addEventListener('click', closeLightbox);
        lightboxDownload.addEventListener('click', handleDownload);
        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

        styleSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('style-tag')) e.target.classList.toggle('active');
        });
        
        countSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('count-tag')) {
                countSelector.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                imageCount = parseInt(e.target.dataset.count, 10);
            }
        });
        
        comparisonSlider.addEventListener('input', (e) => {
            comparisonAfterImg.style.clipPath = `inset(0 ${100 - e.target.value}% 0 0)`;
        });
        
        // --- Initial State ---
        generateButton.disabled = true;
    </script>
</body>
</html>

